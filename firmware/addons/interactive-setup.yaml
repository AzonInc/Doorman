# Interactive Command Setup Addon

globals:
  - id: command_setup_mode
    type: bool
    restore_value: yes
    initial_value: "true"

button:
  - platform: template
    id: doorman_interactive_setup_start
    name: "Interactive Setup: Start"
    icon: mdi:cog-play
    entity_category: CONFIG
    on_press: 
      - globals.set:
          id: command_setup_mode
          value: "true"
      - script.execute: update_led

  - platform: template
    id: doorman_interactive_setup_cancel
    name: "Interactive Setup: Cancel"
    icon: mdi:cog-stop
    entity_category: CONFIG
    on_press: 
      - globals.set:
          id: command_setup_mode
          value: "false"
      - script.execute: update_led

# Extend TCS Intercom Component
tcs_intercom:
  on_command_action:
    - if:
        condition:
          - lambda: return id(command_setup_mode) == true && (x.type == COMMAND_TYPE_FLOOR_CALL || x.type == COMMAND_TYPE_DOOR_CALL);
        then:
          - lambda: |-
              // Save serial number
              id(intercom_serial_number) = x.serial_number;

          - globals.set:
              id: command_setup_mode
              value: "false"

          - light.turn_on:
              id: doorman_rgb_status_led
              red: 0%
              green: 100%
              blue: 10%
              effect: none

          - delay: 3s
          
          - script.execute: update_led

          - logger.log: Setup done
            
script:
  - id: !extend update_led
    then:
      - if:
          condition:
            - lambda: |-
                return id(command_setup_mode) == true;
          then:
            - light.turn_on:
                id: doorman_rgb_status_led
                red: 0%
                green: 100%
                blue: 10%
                effect: pulse
          else:
            - light.turn_off:
                id: doorman_rgb_status_led
                transition_length: 1s