# Interactive Setup Addon

switch:
  - platform: template
    name: Setup Mode
    icon: mdi:cog
    id: doorman_setup_mode
    restore_mode: RESTORE_DEFAULT_ON
    entity_category: CONFIG
    optimistic: true
    turn_on_action:
        - status.push:
            trigger_id: setup_mode
    turn_off_action:
      - status.pop:
          trigger_id: setup_mode
      - status.pop:
          trigger_id: setup_mode_complete
    web_server:
      sorting_group_id: sorting_group_system
      sorting_weight: -19

# Extend TC:BUS Component
tc_bus:
  on_command:
    # If no second door station id is set, wait for one
    - if:
        condition:
          - lambda: return id(second_door_station_id).state == 63 && (x.type == COMMAND_TYPE_DOOR_CALL || x.type == COMMAND_TYPE_OPEN_DOOR) && x.address != id(entrance_door_station_id).state;
        then:
          - number.set:
              id: second_door_station_id
              value: !lambda "return x.address;"

    # Setup mode: Wait for Floor or Door Call
    - if:
        condition:
          - switch.is_on: doorman_setup_mode
          - lambda: "return x.type == COMMAND_TYPE_FLOOR_CALL || x.type == COMMAND_TYPE_DOOR_CALL;"
        then:
          - number.set:
              id: serial_number
              value: !lambda "return x.serial_number;"

          - switch.turn_off: doorman_setup_mode

          - status.push:
              trigger_id: setup_mode_complete

          - logger.log: Setup done

status_indicator:
 on_custom_status:
    - trigger_id: setup_mode
      then:
        - light.turn_on:
            id: doorman_rgb_status_led
            red: 0%
            green: 100%
            blue: 10%
            effect: pulse
            
    - trigger_id: setup_mode_complete
      then:
        - light.turn_on:
              id: doorman_rgb_status_led
              red: 0%
              green: 100%
              blue: 10%
              effect: none
        - delay: 3s
        - status.pop:
            trigger_id: setup_mode_complete